# ==========================
# ===  General settings  ===
# ==========================

set -g default-terminal "screen-256color"
# set -g default-terminal "xterm-256color"
# set-option -ga terminal-overrides ",xterm*:Tc"
set -g history-limit 20000
set -g buffer-limit 20
set -sg escape-time 0
set -g display-time 1500
set -g remain-on-exit off
set -g repeat-time 300
setw -g allow-rename off
setw -g automatic-rename off
setw -g aggressive-resize on

# force xterm keys
setw -g xterm-keys on

# Change prefix key to C-q, easier to type. Used to be C-a, same to "screen"
unbind C-b
set -g prefix C-q

# Set parent terminal title to reflect current window in tmux session
set -g set-titles on
set -g set-titles-string "#I:#W"

# Start index of window/pane with 1, because we're humans, not computers
set -g base-index 1
setw -g pane-base-index 1


# ==========================
# ===   Key bindings     ===
# ==========================

# Unbind default key bindings, we're going to override
unbind "\$"    # rename-session
unbind ,       # rename-window
unbind %       # split-window -h
unbind '"'     # split-window
unbind '}'     # swap-pane -D
unbind '{'     # swap-pane -U
unbind [       # paste-buffer
unbind ]       # paste-buffer
unbind (       # switch to previous client
unbind )       # switch to next client
unbind "'"     # select-window
unbind n       # next-window
unbind p       # previous-window
unbind l       # last-window
unbind M-n     # next window with alert
unbind M-p     # previous window with alert
unbind E       # spread panes out evenly
unbind DC      # reset so the visible part of the window follows the cursor
unbind PPage   # enter copy mode and scroll up
unbind o       # focus thru panes
unbind &       # kill-window
unbind "#"     # list-buffer
unbind =       # choose-buffer
unbind M-Up    # resize 5 rows up
unbind M-Down  # resize 5 rows down
unbind M-Right # resize 5 rows right
unbind M-Left  # resize 5 rows left
unbind M-1     # Set the even-horizontal layout
unbind M-2     # Set the even-vertical layout
unbind M-3     # Set the main-horizontal layout
unbind M-4     # Set the main-vertical layout
unbind M-5     # Select the tiled layout
unbind M-o     # Rotate through the panes in reverse
unbind C-Up    # Resize the pane up
unbind C-Down  # Resize the pane down
unbind C-Left  # Resize the pane left
unbind C-Right # Resize the pane right
unbind S-Up    # Move the visible part of the window up
unbind S-Down  # Move the visible part of the window down
unbind S-Left  # Move the visible part of the window left
unbind S-Right # Move the visible part of the window right

# Reload tmux configuration
bind C-r source-file ~/.tmux.conf \; display "Config reloaded"

# new window
bind c new-window

# Rename session and window
bind r command-prompt -I "#{window_name}" "rename-window '%%'"
bind R command-prompt -I "#{session_name}" "rename-session '%%'"

# Split panes
bind | split-window -h
bind _ split-window -v

# Select pane and windows
bind -n C-Left previous-window
bind -n C-Right next-window

bind ] switch-client -n
bind [ switch-client -l

# Kill pane/window/session shortcuts
bind x kill-pane
bind X kill-window
bind C-x confirm-before -p "kill other windows? (y/n)" "kill-window -a"
bind Q confirm-before -p "kill-session #S? (y/n)" kill-session

# Detach from session
bind d detach


# ================================================
# ===     Copy mode, scroll and clipboard      ===
# ================================================

set -g @copy_use_osc52_fallback on

# Prefer vi style key table
setw -g mode-keys vi

bind p paste-buffer
bind C-p choose-buffer

# trigger copy mode by
bind -n C-Up copy-mode

# wrap default shell in reattach-to-user-namespace if available
# there is some hack with `exec & reattach`, credits to "https://github.com/gpakosz/.tmux"
# don't really understand how it works, but at least window are not renamed to "reattach-to-user-namespace"
if -b "command -v reattach-to-user-namespace > /dev/null 2>&1" \
  "run 'tmux set -g default-command \"exec $(tmux show -gv default-shell) 2>/dev/null & reattach-to-user-namespace -l $(tmux show -gv default-shell)\"'"

yank="~/.tmux/yank.sh"


# =====================================
# ===           Theme               ===
# =====================================

# Feel free to NOT use this variables at all (remove, rename)
# this are named colors, just for convenience
color_darkgray="colour236"
color_teal="colour117"
color_green="colour73"
color_purple="colour171"
color_yellow="colour220"
color_red="colour160"
color_black="colour232"
color_white="white"

# This is a theme CONTRACT, you are required to define variables below
# Change values, but not remove/rename variables itself
color_dark="$color_black"
color_light="$color_white"
color_session_text="$color_purple"
color_status_text="colour245"
color_main="$color_darkgray"
color_secondary="$color_teal"
color_level_ok="$color_green"
color_level_warn="$color_yellow"
color_level_stress="$color_red"
color_window_off_indicator="colour088"
color_window_off_status_bg="colour238"
color_window_off_status_current_bg="colour254"


# =====================================
# ===    Appearence and status bar  ===
# ======================================

# Set port of SSH remote tunnel, where tmux will pipe buffers to transfer on local machine for copy
set -g @copy_backend_remote_tunnel_port 11988

set -g status-bg "$color_dark"
set -g status-fg "$color_white"
setw -g window-status-current-bg "$color_darkgray"
setw -g window-status-current-fg "$color_teal"

setw -g window-status-format " #I:#W "
setw -g window-status-current-format " #I:#W* "

# window segments in status line
set -g window-status-separator ""
separator_powerline_left=""
separator_powerline_right=""

# general status bar settings
set -g status on
set -g status-interval 5
set -g status-position top
set -g status-justify left
set -g status-right-length 100

# define widgets we're going to use in status bar
wg_date="#[fg=$color_secondary]%a %d %h %H:%M#[default]"
wg_user_host="#[fg=$color_secondary]#(whoami)#[default]@#H"

set -g status-left "‚óè REMOTE "
set -g status-right "| $wg_user_host | $wg_date"

# DATE FORMAT
# %a = Short date, Sun
# %A = Long date, Sunday
# %b = Short Month, Feb
# %B = Long Month, February
# %d = Day of the month
# %D = Date such as %m/%d/%y
# %H = Hour in 24 hour format (00..23)
# %I = Hour in 12 hour format (01..12) (this can be used with %p to append Am or PM)
# %j = Day of the year
# %m = Month in number format (01..12)
# %M = Minute (00..59)
# %p = Locale either AM or PM
# %S = Second
# %u = Day of the week
# %V = Week number of year with Monday as first day of week (01..53)
# %Y = Year
# %z = Numeric timezone (e.g., -0400) or %Z with timezone abbreviation.


# =====================================
# ===        Renew environment      ===
# =====================================
set -g update-environment \
  "DISPLAY\
  SSH_ASKPASS\
  SSH_AUTH_SOCK\
  SSH_AGENT_PID\
  SSH_CONNECTION\
  SSH_TTY\
  WINDOWID\
  XAUTHORITY"

bind '$' run "~/.tmux/renew_env.sh"


# ==============================================
